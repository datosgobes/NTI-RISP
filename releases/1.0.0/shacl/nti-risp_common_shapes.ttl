@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix adms: <http://www.w3.org/ns/adms#> .
@prefix cc: <http://creativecommons.org/ns#> .
@prefix dc: <http://purl.org/dc/elements/1.1/> .
@prefix dcat: <http://www.w3.org/ns/dcat#> .
@prefix dct: <http://purl.org/dc/terms/> .
@prefix foaf: <http://xmlns.com/foaf/0.1/> .
@prefix org: <http://www.w3.org/ns/org#> .
@prefix owl: <http://www.w3.org/2002/07/owl#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix schema: <http://schema.org/> .
@prefix sh: <http://www.w3.org/ns/shacl#> .
@prefix skos: <http://www.w3.org/2004/02/skos/core#> .
@prefix time: <http://www.w3.org/2006/time#> .
@prefix vcard: <http://www.w3.org/2006/vcard/ns#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix dcatap: <http://data.europa.eu/r5r/> .
@prefix ntirisp: <https://datosgobes.github.io/NTI-RISP/#> .

<https://datosgobes.github.io/NTI-RISP/releases/1.0.0/shacl/nti-risp_common_shapes.ttl>
    rdf:type owl:Ontology ;
    rdfs:label "Restricciones comunes NTI-RISP (2013)."@es ;
    rdfs:label "Common restrictions for NTI-RISP (2013)"@en ;
    dcat:downloadURL <https://datosgobes.github.io/NTI-RISP/releases/1.0.0/shacl/shacl_distribution_shape.ttl> ;
    dct:format <http://publications.europa.eu/resource/authority/file-type/RDF_TURTLE> ;
    dct:conformsTo <https://www.w3.org/TR/shacl> ;
    dct:description "Este documento especifica restricciones comunes utilizadas en varios shapes del modelo de metadatos NTI-RISP (2013)."@es ;
    dct:description "This file specifies common restrictions used in various shapes of the NTI-RISP metadata model (2013)."@en ;
    owl:versionInfo "1.0.0" ;
    dct:modified "2024-10-17"^^xsd:date ;
    dct:publisher <http://datos.gob.es/recurso/sector-publico/org/Organismo/E0DAT0001> ;
    cc:attributionURL <https://datos.gob.es/> ;
    dcatap:availability <http://data.europa.eu/r5r/stable> ;
    foaf:homepage <https://datosgobes.github.io/NTI-RISP/> .

ntirisp:DateOrDateTimeDataType_Shape
    a sh:NodeShape ;
    rdfs:comment "Restricción para formatos de fecha ISO-8601"@es ;
    sh:or (
        [
            sh:datatype xsd:date ;
        ]
        [
            sh:datatype xsd:dateTime ;
        ]
        [
            # Permitir literales en formato ISO sin tipado explícito
            sh:pattern "^[0-9]{4}-[0-9]{2}-[0-9]{2}(T[0-9]{2}:[0-9]{2}:[0-9]{2}(Z|[+-][0-9]{2}:[0-9]{2})?)?$" ;
        ]
    ) ;
    sh:message "El valor debe ser una fecha válida en formato ISO-8601: YYYY-MM-DDThh:mm:ssTZD"@es .

# Shape modular para texto multilingüe
ntirisp:MultilingualText_Shape
    a sh:NodeShape ;
    rdfs:comment "Restricción modular para literales de texto con etiquetas de idiomas"@es ;
    sh:nodeKind sh:Literal ;
    sh:datatype rdf:langString ;
    sh:languageIn ("es" "ca" "eu" "ga" "en" "fr") ;
    sh:minLength 1 ;
    sh:message "El valor debe ser un literal con etiqueta de idioma válida (es, ca, eu, ga, en, fr) y no puede estar vacío"@es .

ntirisp:NonEmptyLiteral_Shape
    a sh:NodeShape ;
    rdfs:comment "Restricción para literales no vacíos"@es ;
    sh:minLength 1 ;
    sh:message "El valor no puede estar vacío"@es .

# Shape para validar colecciones de texto multilingüe (requiere al menos español)
ntirisp:MultilingualTextCollection_Shape
    a sh:NodeShape ;
    rdfs:comment "Restricción para colecciones de literales multilingües con al menos uno en español"@es ;
    # Cada valor individual debe ser un literal con etiqueta de idioma
    sh:property [
        sh:path [ sh:zeroOrMorePath rdf:rest ] ;
        sh:property [
            sh:path rdf:first ;
            sh:node ntirisp:MultilingualText_Shape ;
        ]
    ] ;
    # Al menos un valor debe estar en español
    sh:qualifiedMinCount 1 ;
    sh:qualifiedValueShape [
        sh:languageIn ("es") ;
        sh:nodeKind sh:Literal ;
        sh:datatype rdf:langString ;
    ] ;
    sh:message "Debe haber al menos un valor en español y todos los valores deben tener etiquetas de idioma válidas"@es .

ntirisp:LiteralMultilingual_Shape
    a sh:NodeShape ;
    rdfs:comment "Restricción para literales multilingües"@es ;
    sh:datatype rdf:langString ;
    sh:languageIn ("es" "ca" "eu" "ga" "en" "fr") ;
    sh:message "El valor debe ser un literal con etiqueta de idioma válida (es, ca, eu, ga, en, fr)"@es .

ntirisp:RecommendedMultilingualLiteral_Shape
    a sh:NodeShape ;
    rdfs:comment "Recomendación para literales en múltiples idiomas"@es ;
    sh:or (
        [
            sh:languageIn ("ca") ;
            sh:minCount 1 ;
        ]
        [
            sh:languageIn ("eu") ;
            sh:minCount 1 ;
        ]
        [
            sh:languageIn ("ga") ;
            sh:minCount 1 ;
        ]
        [
            sh:languageIn ("en") ;
            sh:minCount 1 ;
        ]
        [
            sh:languageIn ("fr") ;
            sh:minCount 1 ;
        ]
    ) ;
    sh:message "Se recomienda proporcionar valores en otros idiomas además del español"@es .

ntirisp:NonLiteralMultilingual_Shape
    a sh:NodeShape ;
    rdfs:comment "Restricción para literales sin etiqueta de idioma"@es ;
    sh:not [
        sh:datatype rdf:langString ;
    ] ;
    sh:message "El valor no debe incluir etiqueta de idioma"@es .

ntirisp:LanguageRestriction_Shape
    a sh:NodeShape ;
    rdfs:comment "Restricción para valores de idioma permitidos en dc:language"@es ;
    sh:nodeKind sh:Literal ;
    sh:in ("es" "ga" "ca" "eu" "en" "fr") ;
    sh:message "El valor de dc:language debe ser uno de los idiomas permitidos: 'es', 'ga', 'ca', 'eu', 'en', 'fr'"@es .

ntirisp:Frequency_Shape
    a sh:NodeShape ;
    rdfs:comment "Validación para estructuras dct:Frequency usadas en dct:accrualPeriodicity"@es ;
    sh:or (
        # Opción 1: rdf:value apuntando a un recurso time:DurationDescription
        [
            sh:property [
                sh:path rdf:value ;
                sh:minCount 1 ;
                sh:maxCount 1 ;
                sh:nodeKind sh:BlankNodeOrIRI ;
                sh:class time:DurationDescription ;
                sh:node ntirisp:TimeDurationDescription_Shape ;
                sh:message "dct:Frequency debe contener exactamente un rdf:value con una estructura time:DurationDescription válida"@es ;
            ]
        ]
        # Opción 2: rdf:value como literal xsd:duration o xsd:timePeriod y rdfs:label
        [
            sh:property [
                sh:path rdf:value ;
                sh:or (
                    [ sh:datatype xsd:duration ]
                    [ sh:datatype <http://www.w3.org/2001/XMLSchema#timePeriod> ]
                ) ;
                sh:pattern "^P([0-9]+Y)?([0-9]+M)?([0-9]+D)?(T([0-9]+H)?([0-9]+M)?([0-9]+S)?)?$" ;
                sh:minCount 1 ;
                sh:maxCount 1 ;
                sh:message "rdf:value debe ser un literal xsd:duration o xsd:timePeriod (ejemplo: P0Y3M0DT0H0M0S) y cumplir el patrón ISO-8601"@es ;
            ] ;
            sh:property [
                sh:path rdfs:label ;
                sh:minCount 1 ;
                sh:nodeKind sh:Literal ;
                sh:message "Debe incluir al menos un rdfs:label descriptivo"@es ;
            ]
        ]
    ) ;
    sh:message "La estructura dct:Frequency no cumple con los requisitos"@es .

ntirisp:TimeDurationDescription_Shape
    a sh:NodeShape ;
    rdfs:comment "Validación para estructuras time:DurationDescription usadas en dct:accrualPeriodicity"@es ;
    sh:property [
        sh:path time:years ;
        sh:datatype xsd:decimal ;
        sh:minInclusive 0 ;
        sh:message "El valor de 'time:years' debe ser un número decimal mayor o igual a 0"@es ;
    ] ;
    sh:property [
        sh:path time:months ;
        sh:datatype xsd:decimal ;
        sh:minInclusive 0 ;
        sh:message "El valor de 'time:months' debe ser un número decimal mayor o igual a 0"@es ;
    ] ;
    sh:property [
        sh:path time:days ;
        sh:datatype xsd:decimal ;
        sh:minInclusive 0 ;
        sh:message "El valor de 'time:days' debe ser un número decimal mayor o igual a 0"@es ;
    ] ;
    sh:property [
        sh:path time:hours ;
        sh:datatype xsd:decimal ;
        sh:minInclusive 0 ;
        sh:message "El valor de 'time:hours' debe ser un número decimal mayor o igual a 0"@es ;
    ] ;
    sh:property [
        sh:path time:minutes ;
        sh:datatype xsd:decimal ;
        sh:minInclusive 0 ;
        sh:message "El valor de 'time:minutes' debe ser un número decimal mayor o igual a 0"@es ;
    ] ;
    sh:property [
        sh:path time:seconds ;
        sh:datatype xsd:decimal ;
        sh:minInclusive 0 ;
        sh:message "El valor de 'time:seconds' debe ser un número decimal mayor o igual a 0"@es ;
    ] ;
    sh:property [
        sh:path rdfs:label ;
        sh:minCount 1 ;
        sh:nodeKind sh:Literal ;
        sh:minLength 1 ;
        sh:severity sh:Warning ;
        sh:message "Se recomienda incluir un rdfs:label descriptivo en time:DurationDescription"@es ;
    ] ;
    # Validación de que al menos una propiedad de tiempo está presente
    sh:or (
        [ sh:path time:years ; sh:minCount 1 ]
        [ sh:path time:months ; sh:minCount 1 ]
        [ sh:path time:days ; sh:minCount 1 ]
        [ sh:path time:hours ; sh:minCount 1 ]
        [ sh:path time:minutes ; sh:minCount 1 ]
        [ sh:path time:seconds ; sh:minCount 1 ]
    ) ;
    sh:message "Una estructura time:DurationDescription debe incluir al menos una propiedad de tiempo (years, months, days, etc.)"@es .

# Shape para el período de tiempo con soporte para múltiples sintaxis
ntirisp:PeriodOfTime_Shape
    a sh:NodeShape ;
    rdfs:comment "Validación para estructuras dct:PeriodOfTime que definen un intervalo temporal. Solo se permiten propiedades dcat:* o time:*, NO schema:*"@es ;
    
    # Validación consolidada: rechazar schema:* y requerir dcat:* o time:*
    sh:xone (
        # Opción 1: Usar dcat:startDate (y opcionalmente dcat:endDate)
        [
            sh:property [
                sh:path dcat:startDate ;
                sh:minCount 1 ;
                sh:maxCount 1 ;
                sh:nodeKind sh:Literal ;
                sh:or (
                    [ sh:datatype xsd:date ]
                    [ sh:datatype xsd:dateTime ]
                ) ;
            ] ;
            sh:property [
                sh:path dcat:endDate ;
                sh:maxCount 1 ;
                sh:nodeKind sh:Literal ;
                sh:or (
                    [ sh:datatype xsd:date ]
                    [ sh:datatype xsd:dateTime ]
                ) ;
            ] ;
            sh:property [
                sh:path schema:startDate ;
                sh:maxCount 0 ;
            ] ;
            sh:property [
                sh:path schema:endDate ;
                sh:maxCount 0 ;
            ] ;
        ]
        # Opción 2: Usar time:hasBeginning (y opcionalmente time:hasEnd)
        [
            sh:property [
                sh:path time:hasBeginning ;
                sh:minCount 1 ;
                sh:maxCount 1 ;
                sh:class time:Instant ;
            ] ;
            sh:property [
                sh:path time:hasEnd ;
                sh:maxCount 1 ;
                sh:class time:Instant ;
            ] ;
            sh:property [
                sh:path schema:startDate ;
                sh:maxCount 0 ;
            ] ;
            sh:property [
                sh:path schema:endDate ;
                sh:maxCount 0 ;
            ] ;
        ]
    ) ;
    sh:message "Un período de tiempo debe usar ÚNICAMENTE propiedades dcat:startDate/dcat:endDate O time:hasBeginning/time:hasEnd. Las propiedades schema:startDate y schema:endDate NO están permitidas en NTI-RISP. Por favor, reemplace schema:startDate con dcat:startDate y schema:endDate con dcat:endDate."@es ;
    
    sh:targetClass dct:PeriodOfTime ;
    sh:targetClass time:Interval .

# Shape para validar estructuras dct:IMT (formatos MIME)
ntirisp:MediaType_Shape
    a sh:NodeShape ;
    rdfs:comment "Validación para estructuras dct:IMT (IANA media type)"@es ;
    sh:class dct:IMT ;
    sh:property [
        sh:path rdf:value ;
        sh:nodeKind sh:Literal ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:pattern "^[a-z0-9]+/[a-z0-9.+-]+$" ;
        sh:message "El valor debe seguir la estructura estandarizada de tipos MIME: tipo/subtipo"@es ;
    ] ;
    sh:property [
        sh:path rdfs:label ;
        sh:nodeKind sh:Literal ;
        sh:message "Se recomienda incluir una etiqueta descriptiva del formato"@es ;
        sh:severity sh:Warning ;
    ] .

ntirisp:DIR3OrganismRestriction
    a sh:NodeShape ;
    rdfs:comment "Restricción de organismo del sector público según codificación DIR3"@es ;
    rdfs:label "Restricción de organismo del sector público"@es ;
    # Validación: debe ser un IRI del directorio de organismos siguiendo la codificación DIR3
    sh:nodeKind sh:IRI ;
    sh:pattern "^http://datos\\.gob\\.es/recurso/sector-publico/org/Organismo/[A-Z][A-Z0-9]{8}$" ;
    sh:message "El valor debe ser un IRI del directorio de organismos DIR3 con formato http://datos.gob.es/recurso/sector-publico/org/Organismo/{ID}, donde ID es un código alfanumérico de 9 caracteres que puede comenzar con E (Administración General del Estado), A (Administración Autonómica), L (Administración Local), P (Entidades privadas), U (Universidades), etc."@es ;
    sh:severity sh:Violation .